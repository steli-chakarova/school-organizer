{% extends "mobile_base.html" %}
{% load organizer_extras %}

{% block title %}History - School Organizer{% endblock %}

{% block content %}
<div class="mobile-container">
    <h2 class="mobile-page-title">{% if target_user %}{{ target_user.get_display_name }}{% else %}History{% endif %}</h2>
    
    <!-- Mobile Calendar Navigation -->
    <div class="mobile-calendar-nav">
        <button onclick="navigateMonth('prev')" class="mobile-nav-btn">
            <span class="mobile-nav-icon">←</span>
        </button>
        <h3 class="mobile-month-year">
            {% if month == 1 %}January
            {% elif month == 2 %}February
            {% elif month == 3 %}March
            {% elif month == 4 %}April
            {% elif month == 5 %}May
            {% elif month == 6 %}June
            {% elif month == 7 %}July
            {% elif month == 8 %}August
            {% elif month == 9 %}September
            {% elif month == 10 %}October
            {% elif month == 11 %}November
            {% elif month == 12 %}December
            {% endif %} {{ year }}
        </h3>
        <button onclick="navigateMonth('next')" class="mobile-nav-btn">
            <span class="mobile-nav-icon">→</span>
        </button>
    </div>
    
    <!-- Mobile Calendar Grid -->
    <div class="mobile-calendar-container">
        <div class="mobile-calendar-header">
            <div class="mobile-day-header">Mon</div>
            <div class="mobile-day-header">Tue</div>
            <div class="mobile-day-header">Wed</div>
            <div class="mobile-day-header">Thu</div>
            <div class="mobile-day-header">Fri</div>
            <div class="mobile-day-header">Sat</div>
            <div class="mobile-day-header">Sun</div>
        </div>
        
        <div class="mobile-calendar-grid">
            {% for week in cal_data %}
            <div class="mobile-calendar-week">
                {% for day_date in week %}
                <div class="mobile-calendar-day 
                    {% if day_date.month != month %}other-month{% endif %}
                    {% if day_date.day in days_with_entries %}has-entries{% endif %}
                    {% if selected_date and day_date == selected_date %}selected{% endif %}"
                    onclick="selectMobileDate('{{ day_date|date:"Y-m-d" }}')">
                    <span class="mobile-day-number">
                        {{ day_date.day }}
                    </span>
                    {% if day_date.day in days_with_entries %}
                    <span class="mobile-entry-indicator">●</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Mobile Daily Data Display -->
    {% if selected_date %}
    <div class="mobile-daily-data">
        <div class="mobile-date-header">
            <h3>{{ selected_date|date:"l, M d, Y" }}</h3>
            <div class="mobile-export-buttons">
                {% if can_edit %}
                <a href="{% if username and user_id %}{% url 'today_user_date' username=username user_id=user_id date=selected_date|date:'d-m-y' %}{% else %}{% url 'today_date' date=selected_date|date:'d-m-y' %}{% endif %}" class="mobile-export-btn mobile-edit-btn">
                    <span class="mobile-btn-icon edit-icon"></span>
                    Edit
                </a>
                {% endif %}
                <a href="{% url 'export_template_date' date=selected_date|date:'d-m-y' %}" class="mobile-export-btn">
                    <span class="mobile-btn-icon pdf-icon"></span>
                    PDF
                </a>
                <a href="{% url 'export_jpeg_date' date=selected_date|date:'d-m-y' %}" class="mobile-export-btn">
                    <span class="mobile-btn-icon image-icon"></span>
                    JPEG
                </a>
            </div>
        </div>
        
        {% if daily_data %}
        <div class="mobile-daily-entries">
            {% for entry in daily_data %}
            {% if entry.has_entry %}
            <div class="mobile-entry-card">
                <h4 class="mobile-subject-title">{{ entry.subject_name }}</h4>
                
                <!-- Mobile Resources Section -->
                {% if entry.book_name or entry.extras %}
                <div class="mobile-section">
                    <h5 class="mobile-section-title">Resources:</h5>
                    {% if entry.book_name and entry.pages %}
                    <div class="mobile-detail-row">
                        <strong>→</strong> {{ entry.book_name }} стр. {{ entry.pages }}
                    </div>
                    {% elif entry.book_name %}
                    <div class="mobile-detail-row">
                        <strong>→</strong> {{ entry.book_name }}
                    </div>
                    {% endif %}
                    
                    {% if entry.extras %}
                    {% for extra in entry.extras %}
                    {% if extra.book_name and extra.pages %}
                    <div class="mobile-detail-row">
                        <strong>→</strong> {{ extra.book_name }} стр. {{ extra.pages }}
                    </div>
                    {% elif extra.book_name %}
                    <div class="mobile-detail-row">
                        <strong>→</strong> {{ extra.book_name }}
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Mobile Notes Section -->
                {% if entry.notes %}
                <div class="mobile-section">
                    <h5 class="mobile-section-title">Notes:</h5>
                    <div class="mobile-detail-row rich-text-content">
                        {{ entry.notes|render_rich_text_safe }}
                    </div>
                </div>
                {% endif %}
                
                <!-- Mobile Homework Section -->
                {% if entry.homework %}
                <div class="mobile-section">
                    <h5 class="mobile-section-title">Homework:</h5>
                    {% for homework in entry.homework %}
                    {% if homework.book_name and homework.pages %}
                    <div class="mobile-detail-row">
                        <strong>→</strong> {{ homework.book_name }} стр. {{ homework.pages }}
                    </div>
                    {% elif homework.book_name %}
                    <div class="mobile-detail-row">
                        <strong>→</strong> {{ homework.book_name }}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Mobile Important Notes Section -->
                {% if entry.important_notes %}
                <div class="mobile-section">
                    <h5 class="mobile-section-title">Important Notes:</h5>
                    <div class="mobile-detail-row rich-text-content">
                        {{ entry.important_notes|render_rich_text_safe }}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% else %}
        <div class="mobile-no-data">
            <p>No data saved for this day.</p>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
function navigateMonth(direction) {
    const currentYear = {{ year }};
    const currentMonth = {{ month }};
    
    let newYear = currentYear;
    let newMonth = currentMonth;
    
    if (direction === 'prev') {
        newMonth = currentMonth - 1;
        if (newMonth < 1) {
            newMonth = 12;
            newYear = currentYear - 1;
        }
    } else if (direction === 'next') {
        newMonth = currentMonth + 1;
        if (newMonth > 12) {
            newMonth = 1;
            newYear = currentYear + 1;
        }
    }
    
    // Navigate to the new month
    {% if username and user_id %}
    window.location.href = `{% url 'history_user' username=username user_id=user_id %}?year=${newYear}&month=${newMonth}`;
    {% else %}
    window.location.href = `{% url 'history_user' username=user.username user_id=user.id %}?year=${newYear}&month=${newMonth}`;
    {% endif %}
}

function selectMobileDate(dateStr) {
    // Convert YYYY-MM-DD to DD-MM-YY format for the URL
    const date = new Date(dateStr);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = String(date.getFullYear()).slice(-2);
    const formattedDate = `${day}-${month}-${year}`;
    
    // Navigate to the history view with the date
    {% if username and user_id %}
    window.location.href = `/history/{{ username }}/{{ user_id }}/${formattedDate}/`;
    {% else %}
    window.location.href = `/history/{{ user.username }}/{{ user.id }}/${formattedDate}/`;
    {% endif %}
}

// Add touch event support for mobile calendar
document.addEventListener('DOMContentLoaded', function() {
    const calendarDays = document.querySelectorAll('.mobile-calendar-day');
    
    calendarDays.forEach(day => {
        // Add touch feedback
        day.addEventListener('touchstart', function() {
            this.classList.add('mobile-touch-active');
        });
        
        day.addEventListener('touchend', function() {
            setTimeout(() => {
                this.classList.remove('mobile-touch-active');
            }, 150);
        });
        
    });
});
</script>
{% endblock %}
