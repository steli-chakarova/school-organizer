{% extends "base.html" %}
{% load organizer_extras %}

{% block title %}History - School Organizer{% endblock %}

{% block content %}
<div class="container">
    <h2>{% if target_user %}{{ target_user.get_display_name }}{% else %}History{% endif %}</h2>
    
    <!-- Calendar Navigation -->
    <div class="history-calendar-nav">
        <a href="{% url 'history_user' username=username user_id=user_id %}?year={{ prev_year }}&month={{ prev_month }}" class="history-nav-btn">&larr; Previous</a>
        <h3>
            {% if month == 1 %}January
            {% elif month == 2 %}February
            {% elif month == 3 %}March
            {% elif month == 4 %}April
            {% elif month == 5 %}May
            {% elif month == 6 %}June
            {% elif month == 7 %}July
            {% elif month == 8 %}August
            {% elif month == 9 %}September
            {% elif month == 10 %}October
            {% elif month == 11 %}November
            {% elif month == 12 %}December
            {% endif %} {{ year }}
        </h3>
        <a href="{% url 'history_user' username=username user_id=user_id %}?year={{ next_year }}&month={{ next_month }}" class="history-nav-btn">Next &rarr;</a>
    </div>
    
    <!-- Calendar Grid -->
    <div class="history-calendar-container">
        <div class="history-calendar-header">
            <div class="history-day-header">Mon</div>
            <div class="history-day-header">Tue</div>
            <div class="history-day-header">Wed</div>
            <div class="history-day-header">Thu</div>
            <div class="history-day-header">Fri</div>
            <div class="history-day-header">Sat</div>
            <div class="history-day-header">Sun</div>
        </div>
        
        <div class="history-calendar-grid">
            {% for week in cal_data %}
            <div class="history-calendar-week">
                {% for day_date in week %}
                <div class="history-calendar-day 
                    {% if day_date.month != month %}other-month{% endif %}
                    {% if day_date.month == month and day_date.day in days_with_entries %}has-entries{% endif %}
                    {% if selected_date and day_date == selected_date %}selected{% endif %}"
                    onclick="selectDate('{{ day_date|date:"Y-m-d" }}')" ondblclick="editDate('{{ day_date|date:"Y-m-d" }}')">
                    <span class="history-day-number">{{ day_date.day }}</span>
                    {% if day_date.month == month and day_date.day in days_with_entries %}
                    <span class="history-entry-indicator">●</span>
                    {% endif %}
                    {% if day_date.month == month and day_date.day in days_with_tests %}
                        {% if day_date.day in days_with_non_school %}
                        <span class="non-school-day-indicator{% if selected_date and day_date == selected_date %} selected{% endif %}"></span>
                        {% else %}
                        <span class="test-indicator{% if selected_date and day_date == selected_date %} selected{% endif %}"></span>
                        {% endif %}
                    {% endif %}
                    <div class="history-day-actions">
                        {% if can_edit %}
                            {% if username and user_id %}
                            <a href="{% url 'today_user_date' username=username user_id=user_id date=day_date|date:'d-m-y' %}" class="history-edit-link" title="Edit this day">
                                <span class="desktop-btn-icon edit-icon"></span>
                            </a>
                            {% else %}
                            <a href="{% url 'today_date' date=day_date|date:'d-m-y' %}" class="history-edit-link" title="Edit this day">
                                <span class="desktop-btn-icon edit-icon"></span>
                            </a>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Subject Date Range Export Form -->
    <div class="subject-export-section" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px;">
        <h3 style="margin-top: 0; margin-bottom: 15px;">Export by Subject and Date Range</h3>
        <form method="get" action="{% url 'export_subject_date_range' %}" id="subject-export-form" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">
            <input type="hidden" name="username" value="{{ username }}">
            <input type="hidden" name="user_id" value="{{ user_id }}">
            
            <div style="flex: 1; min-width: 200px;">
                <label for="subject_id" style="display: block; margin-bottom: 5px; font-weight: 600;">Subject:</label>
                <select name="subject_id" id="subject_id" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- Select Subject --</option>
                    {% for subject in subjects %}
                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div style="flex: 1; min-width: 150px;">
                <label for="start_date" style="display: block; margin-bottom: 5px; font-weight: 600;">Start Date:</label>
                <div style="position: relative;">
                    <input type="text" name="start_date_display" id="start_date_display" value="{{ yesterday|date:'d/m/Y' }}" placeholder="dd/mm/yyyy" pattern="\d{2}/\d{2}/\d{4}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; padding-right: 35px;">
                    <input type="date" id="start_date_picker" value="{{ yesterday|date:'Y-m-d' }}" style="position: absolute; right: 0; top: 0; width: 30px; height: 100%; opacity: 0; cursor: pointer; z-index: 1;">
                    <input type="hidden" name="start_date" id="start_date" value="{{ yesterday|date:'Y-m-d' }}">
                </div>
            </div>
            
            <div style="flex: 1; min-width: 150px;">
                <label for="end_date" style="display: block; margin-bottom: 5px; font-weight: 600;">End Date:</label>
                <div style="position: relative;">
                    <input type="text" name="end_date_display" id="end_date_display" value="{{ today|date:'d/m/Y' }}" placeholder="dd/mm/yyyy" pattern="\d{2}/\d{2}/\d{4}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; padding-right: 35px;">
                    <input type="date" id="end_date_picker" value="{{ today|date:'Y-m-d' }}" style="position: absolute; right: 0; top: 0; width: 30px; height: 100%; opacity: 0; cursor: pointer; z-index: 1;">
                    <input type="hidden" name="end_date" id="end_date" value="{{ today|date:'Y-m-d' }}">
                </div>
            </div>
            
            <div style="flex: 0 0 auto; align-self: flex-end;">
                <button type="submit" class="history-export-btn" style="display: flex; align-items: center; gap: 0.5rem;">
                    <span class="desktop-btn-icon pdf-icon"></span>
                    Export PDF
                </button>
            </div>
        </form>
    </div>
    
    <!-- Daily Data Display -->
    {% if selected_date %}
    <div class="history-daily-data">
        <div class="date-header">
            <h3>{{ selected_date|date:"l, F d, Y" }}</h3>
            <div class="history-export-buttons">
                <a href="{% url 'export_template_date' date=selected_date|date:'d-m-y' %}" class="history-export-btn">
                    <span class="desktop-btn-icon pdf-icon"></span>
                    Export PDF
                </a>
                <a href="{% url 'export_jpeg_date' date=selected_date|date:'d-m-y' %}" class="history-export-btn">
                    <span class="desktop-btn-icon image-icon"></span>
                    Export JPEG
                </a>
            </div>
        </div>
        
        {% if tests_data %}
        <div class="tests-section">
            {% if tests_data|length == 1 %}
            <div class="test-notification">
                {% if tests_data.0.is_non_school_day %}
                <strong>{{ tests_data.0.subject_name }}</strong>
                {% else %}
                <strong>Контролно по {{ tests_data.0.subject_name }}</strong>
                {% endif %}
            </div>
            {% else %}
            <div class="test-notification">
                {% for test in tests_data %}
                {% if test.is_non_school_day %}
                <div><strong>{{ test.subject_name }}</strong></div>
                {% else %}
                <div><strong>Контролно по {{ test.subject_name }}</strong></div>
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        {% if daily_data %}
        <div class="history-daily-entries history-page">
            {% for entry in daily_data %}
            {% if entry.has_entry %}
            <div class="history-entry-card">
                <h4 class="history-subject-title">{{ entry.subject_name }}</h4>
                <div class="entry-content-row">
                    <!-- Left side: Resources and Notes -->
                    <div class="left-content">
                        <div class="history-entry-details">
                            <!-- Resources section -->
                            {% if entry.book_name or entry.extras %}
                            <h5>Resources:</h5>
                            <!-- Main entry resource -->
                            {% if entry.book_name and entry.pages %}
                            <div class="history-detail-row">
                                <strong>→</strong> {{ entry.book_name }} стр. {{ entry.pages }}
                            </div>
                            {% elif entry.book_name %}
                            <div class="history-detail-row">
                                <strong>→</strong> {{ entry.book_name }}
                            </div>
                            {% endif %}
                            
                            <!-- Extra entries resources -->
                            {% if entry.extras %}
                            {% for extra in entry.extras %}
                            {% if extra.book_name and extra.pages %}
                            <div class="history-detail-row">
                                <strong>→</strong> {{ extra.book_name }} стр. {{ extra.pages }}
                            </div>
                            {% elif extra.book_name %}
                            <div class="history-detail-row">
                                <strong>→</strong> {{ extra.book_name }}
                            </div>
                            {% endif %}
                            {% endfor %}
                            {% endif %}
                            {% endif %}
                            
                            <!-- Notes (if any) -->
                            {% if entry.notes %}
                            <h5>Notes:</h5>
                            <div class="history-detail-row rich-text-content">
                                {{ entry.notes|render_rich_text_safe }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Right side: Homework and Important Notes -->
                    <div class="right-content">
                        <!-- Homework section -->
                        {% if entry.homework %}
                        <div class="homework-entries">
                            <h5>Homework:</h5>
                            <div class="homework-container">
                                {% for homework in entry.homework %}
                                {% if homework.book_name and homework.pages %}
                                <div class="history-detail-row">
                                    <strong>→</strong> {{ homework.book_name }} стр. {{ homework.pages }}
                                </div>
                                {% elif homework.book_name %}
                                <div class="history-detail-row">
                                    <strong>→</strong> {{ homework.book_name }}
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Important Notes section -->
                        {% if entry.important_notes %}
                        <div class="important-notes-section">
                            <h5>Important Notes:</h5>
                            <div class="history-detail-row rich-text-content">
                                {{ entry.important_notes|render_rich_text_safe }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% else %}
        <div class="no-data">
            <p>No data saved for this day.</p>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
function selectDate(dateStr) {
    // Convert YYYY-MM-DD to DD-MM-YY format for the URL
    const date = new Date(dateStr);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = String(date.getFullYear()).slice(-2);
    const formattedDate = `${day}-${month}-${year}`;
    
    // Navigate to the history view with the date
    window.location.href = `/history/{{ username }}/{{ user_id }}/${formattedDate}/`;
}

function editDate(dateStr) {
    // Only allow editing if user has permission
    {% if can_edit %}
    // Convert YYYY-MM-DD to DD-MM-YY format for the URL
    const date = new Date(dateStr);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = String(date.getFullYear()).slice(-2);
    const formattedDate = `${day}-${month}-${year}`;
    
    // Navigate to the today page for editing
    {% if username and user_id %}
    window.location.href = `/today/{{ username }}/{{ user_id }}/${formattedDate}/`;
    {% else %}
    window.location.href = `/today/${formattedDate}/`;
    {% endif %}
    {% else %}
    // User doesn't have edit permission - do nothing
    console.log('Edit permission required');
    {% endif %}
}

// Date formatting and picker functionality
document.addEventListener('DOMContentLoaded', function() {
    const startDateDisplay = document.getElementById('start_date_display');
    const endDateDisplay = document.getElementById('end_date_display');
    const startDatePicker = document.getElementById('start_date_picker');
    const endDatePicker = document.getElementById('end_date_picker');
    const startDateHidden = document.getElementById('start_date');
    const endDateHidden = document.getElementById('end_date');
    const startDateLabel = document.querySelector('label[for="start_date"]');
    const endDateLabel = document.querySelector('label[for="end_date"]');
    
    // Convert dd/mm/yyyy to YYYY-MM-DD
    function convertToISO(dateStr) {
        if (!dateStr) return '';
        const parts = dateStr.split('/');
        if (parts.length === 3) {
            const day = parts[0].padStart(2, '0');
            const month = parts[1].padStart(2, '0');
            const year = parts[2];
            return `${year}-${month}-${day}`;
        }
        return '';
    }
    
    // Convert YYYY-MM-DD to dd/mm/yyyy
    function convertToDisplay(dateStr) {
        if (!dateStr) return '';
        const parts = dateStr.split('-');
        if (parts.length === 3) {
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }
        return '';
    }
    
    // Update display when picker changes
    function setupPicker(picker, display, hidden) {
        picker.addEventListener('change', function() {
            const isoDate = picker.value;
            if (isoDate) {
                hidden.value = isoDate;
                display.value = convertToDisplay(isoDate);
            }
        });
        
        // Make display input clickable to trigger picker
        display.addEventListener('click', function() {
            picker.showPicker();
        });
    }
    
    // Validate and format date input
    function formatDateInput(input, picker, hiddenInput) {
        input.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
            
            // Format as dd/mm/yyyy
            if (value.length > 0) {
                if (value.length <= 2) {
                    value = value;
                } else if (value.length <= 4) {
                    value = value.substring(0, 2) + '/' + value.substring(2);
                } else {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4) + '/' + value.substring(4, 8);
                }
                e.target.value = value;
                
                // Update hidden input and picker
                if (value.length === 10) {
                    const isoDate = convertToISO(value);
                    if (isoDate) {
                        hiddenInput.value = isoDate;
                        picker.value = isoDate;
                    }
                }
            }
        });
        
        input.addEventListener('blur', function(e) {
            const value = e.target.value;
            if (value && value.length === 10) {
                const isoDate = convertToISO(value);
                // Validate date
                const date = new Date(isoDate);
                if (isNaN(date.getTime())) {
                    e.target.setCustomValidity('Please enter a valid date in dd/mm/yyyy format');
                } else {
                    e.target.setCustomValidity('');
                    hiddenInput.value = isoDate;
                    picker.value = isoDate;
                }
            }
        });
    }
    
    // Setup for start date
    if (startDateDisplay && startDatePicker && startDateHidden) {
        formatDateInput(startDateDisplay, startDatePicker, startDateHidden);
        setupPicker(startDatePicker, startDateDisplay, startDateHidden);
        
        if (startDateLabel) {
            startDateLabel.style.cursor = 'pointer';
            startDateLabel.addEventListener('click', function() {
                startDatePicker.showPicker();
            });
        }
    }
    
    // Setup for end date
    if (endDateDisplay && endDatePicker && endDateHidden) {
        formatDateInput(endDateDisplay, endDatePicker, endDateHidden);
        setupPicker(endDatePicker, endDateDisplay, endDateHidden);
        
        if (endDateLabel) {
            endDateLabel.style.cursor = 'pointer';
            endDateLabel.addEventListener('click', function() {
                endDatePicker.showPicker();
            });
        }
    }
    
    // Update hidden inputs before form submission
    const form = document.getElementById('subject-export-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (startDateDisplay && startDateHidden) {
                const isoDate = convertToISO(startDateDisplay.value);
                if (isoDate) {
                    startDateHidden.value = isoDate;
                }
            }
            if (endDateDisplay && endDateHidden) {
                const isoDate = convertToISO(endDateDisplay.value);
                if (isoDate) {
                    endDateHidden.value = isoDate;
                }
            }
        });
    }
});
</script>
{% endblock %}