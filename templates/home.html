{% extends "base.html" %}

{% block title %}Weekly Program - School Organizer{% endblock %}

{% block content %}
<div class="container home-page">
    {% if is_admin_view %}
    <div class="admin-notice">
        <h2>Managing {{ target_user.username }}'s Weekly Program</h2>
        <p>You are managing the subjects, books, and schedule for {{ target_user.username }}.</p>
        <a href="{% url 'users' %}" class="back-btn">← Back to Users</a>
    </div>
    {% else %}
    <h2>Weekly Program</h2>
    {% endif %}
    
    <!-- User Alias Management -->
    {% if not is_admin_view %}
    <div class="alias-management">
        <h3>Your Display Name</h3>
        <form method="POST" action="{% url 'home' %}" class="alias-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_alias">
            <div class="form-row">
                <input type="text" name="alias" value="{{ user.alias|default:'' }}" placeholder="Enter your display name (optional)">
                <button type="submit">Update</button>
            </div>
        </form>
        <p class="alias-help">This name will be displayed in the history page instead of your username.</p>
    </div>
    {% endif %}
    
    {% if user.is_admin or user.is_teacher %}
    <!-- Add Subject and Book Forms - Side by Side -->
    <div class="forms-row">
        <div class="form-section">
            <h3>Add New Subject</h3>
            <form method="POST" action="{% if is_admin_view %}{% url 'home_user' target_user.username target_user.id %}{% else %}{% url 'home' %}{% endif %}">
                {% csrf_token %}
                <div class="form-row">
                    <input type="text" name="subject_name" placeholder="Subject name" required>
                    <button type="submit">Add Subject</button>
                </div>
            </form>
        </div>
        
        <div class="form-section">
            <h3>Add Book to Subject</h3>
            <form method="POST" action="{% if is_admin_view %}{% url 'home_user' target_user.username target_user.id %}{% else %}{% url 'home' %}{% endif %}">
                {% csrf_token %}
                <div class="form-row">
                    <select name="subject_id" required>
                        <option value="">Select Subject</option>
                        {% for subject in subjects %}
                        <option value="{{ subject.id }}">{{ subject.name }}</option>
                        {% endfor %}
                    </select>
                    <input type="text" name="book_title" placeholder="Book title" required>
                    <button type="submit">Add Book</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
    
    <!-- Subjects and Books Management -->
    {% if user.is_admin or user.is_teacher %}
    <div class="subjects-books-management">
        <h3>Subjects and Books Management</h3>
        <div style="margin-bottom: 10px;">
            <span style="color: #666; font-size: 12px;">
                Showing data for: {{ user.username }} ({{ user.get_role_display }})
            </span>
        </div>
        <div class="management-table-container">
            <table class="management-table" id="subjects-books-table">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Books</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="subjects-books-tbody">
                    <!-- Dynamic content will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    <!-- Add Test Card -->
    {% if user.is_admin or user.is_teacher %}
    <div class="add-test-section">
        <h3>Add Test</h3>
        <div id="test-chips" class="test-chips-container">
            <!-- Saved tests will appear as chips here -->
        </div>
        <div id="test-entries">
            <div class="test-entry">
                <div class="test-selection-container">
                    <div class="date-selection">
                        <label class="selection-label">Select Date:</label>
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <button type="button" class="calendar-nav-btn" onclick="changeMonth(-1)">‹</button>
                                <span class="calendar-month-year" id="calendar-month-year"></span>
                                <button type="button" class="calendar-nav-btn" onclick="changeMonth(1)">›</button>
                            </div>
                            <div class="calendar-grid" id="calendar-grid">
                                <!-- Calendar will be populated by JavaScript -->
                                <div style="padding: 20px; text-align: center; color: #666;">
                                    Loading calendar...
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="selected-tests-container">
                        <label class="selection-label">Selected Tests:</label>
                        <div class="selected-tests-list" id="selected-tests-list">
                            <!-- Selected tests will appear here as labels -->
                        </div>
                    </div>
                </div>
                <div class="test-entry-actions">
                    <button type="button" class="remove-test-btn" onclick="removeTestEntry(this)" style="display: none;">×</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    
    <!-- Weekly Schedule Form -->
    <div class="schedule-form-section">
        <div class="schedule-form-header" onclick="toggleScheduleForm()">
            <h3>{% if has_active_schedule %}Edit Weekly Schedule{% else %}Create Weekly Schedule{% endif %}</h3>
            <div class="toggle-btn">
                <span id="toggle-text">Show</span> <span id="toggle-icon">▼</span>
            </div>
        </div>
        <div class="schedule-form-content" id="schedule-form-content" style="display: none;">
            <form id="schedule-update-form" method="POST" action="{% if is_admin_view %}{% url 'home_user' target_user.username target_user.id %}{% else %}{% url 'home' %}{% endif %}">
                {% csrf_token %}
                <input type="hidden" name="update_schedule" value="1">
                <div class="schedule-grid">
                <div class="day-column">
                    <h4>Monday</h4>
                    <div class="subjects-list" id="subjects_1">
                        {% for schedule_entry in schedule_by_day.1 %}
                        <div class="subject-item">
                            <select name="subjects_1" class="subject-select">
                                <option value="">Select Subject</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}" {% if schedule_entry.subject.id == subject.id %}selected{% endif %}>{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="remove-subject-btn" onclick="removeSubject(this)">×</button>
                        </div>
                        {% empty %}
                        <div class="subject-item">
                            <select name="subjects_1" class="subject-select">
                                <option value="">Select Subject</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}">{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="remove-subject-btn" onclick="removeSubject(this)">×</button>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="add-subject-btn" onclick="addSubject(1)">+ Add Subject</button>
                </div>
                
                <div class="day-column">
                    <h4>Tuesday</h4>
                    <div class="subjects-list" id="subjects_2">
                        {% for schedule_entry in schedule_by_day.2 %}
                        <div class="subject-item">
                            <select name="subjects_2" class="subject-select">
                                <option value="">Select Subject</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}" {% if schedule_entry.subject.id == subject.id %}selected{% endif %}>{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="remove-subject-btn" onclick="removeSubject(this)">×</button>
                        </div>
                        {% empty %}
                        <div class="subject-item">
                            <select name="subjects_2" class="subject-select">
                                <option value="">Select Subject</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}">{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="remove-subject-btn" onclick="removeSubject(this)">×</button>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="add-subject-btn" onclick="addSubject(2)">+ Add Subject</button>
                </div>
                
                <div class="day-column">
                    <h4>Wednesday</h4>
                    <div class="subjects-list" id="subjects_3">
                        {% for schedule_entry in schedule_by_day.3 %}
                        <div class="subject-item">
                            <select name="subjects_3" class="subject-select">
                                <option value="">Select Subject</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}" {% if schedule_entry.subject.id == subject.id %}selected{% endif %}>{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="remove-subject-btn" onclick="removeSubject(this)">×</button>
                        </div>
                        {% empty %}
                        <div class="subject-item">
                            <select name="subjects_3" class="subject-select">
                                <option value="">Select Subject</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}">{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="remove-subject-btn" onclick="removeSubject(this)">×</button>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="add-subject-btn" onclick="addSubject(3)">+ Add Subject</button>
                </div>
                
                <div class="day-column">
                    <h4>Thursday</h4>
                    <div class="subjects-list" id="subjects_4">
                        {% for schedule_entry in schedule_by_day.4 %}
                        <div class="subject-item">
                            <select name="subjects_4" class="subject-select">
                                <option value="">Select Subject</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}" {% if schedule_entry.subject.id == subject.id %}selected{% endif %}>{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="remove-subject-btn" onclick="removeSubject(this)">×</button>
                        </div>
                        {% empty %}
                        <div class="subject-item">
                            <select name="subjects_4" class="subject-select">
                                <option value="">Select Subject</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}">{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="remove-subject-btn" onclick="removeSubject(this)">×</button>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="add-subject-btn" onclick="addSubject(4)">+ Add Subject</button>
                </div>
                
                <div class="day-column">
                    <h4>Friday</h4>
                    <div class="subjects-list" id="subjects_5">
                        {% for schedule_entry in schedule_by_day.5 %}
                        <div class="subject-item">
                            <select name="subjects_5" class="subject-select">
                                <option value="">Select Subject</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}" {% if schedule_entry.subject.id == subject.id %}selected{% endif %}>{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="remove-subject-btn" onclick="removeSubject(this)">×</button>
                        </div>
                        {% empty %}
                        <div class="subject-item">
                            <select name="subjects_5" class="subject-select">
                                <option value="">Select Subject</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}">{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="remove-subject-btn" onclick="removeSubject(this)">×</button>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="add-subject-btn" onclick="addSubject(5)">+ Add Subject</button>
                </div>
                
                <div class="day-column">
                    <h4>Saturday</h4>
                    <div class="subjects-list" id="subjects_6">
                        {% for schedule_entry in schedule_by_day.6 %}
                        <div class="subject-item">
                            <select name="subjects_6" class="subject-select">
                                <option value="">Select Subject</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}" {% if schedule_entry.subject.id == subject.id %}selected{% endif %}>{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="remove-subject-btn" onclick="removeSubject(this)">×</button>
                        </div>
                        {% empty %}
                        <div class="subject-item">
                            <select name="subjects_6" class="subject-select">
                                <option value="">Select Subject</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}">{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="remove-subject-btn" onclick="removeSubject(this)">×</button>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="add-subject-btn" onclick="addSubject(6)">+ Add Subject</button>
                </div>
                
                <div class="day-column">
                    <h4>Sunday</h4>
                    <div class="subjects-list" id="subjects_7">
                        {% for schedule_entry in schedule_by_day.7 %}
                        <div class="subject-item">
                            <select name="subjects_7" class="subject-select">
                                <option value="">Select Subject</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}" {% if schedule_entry.subject.id == subject.id %}selected{% endif %}>{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="remove-subject-btn" onclick="removeSubject(this)">×</button>
                        </div>
                        {% empty %}
                        <div class="subject-item">
                            <select name="subjects_7" class="subject-select">
                                <option value="">Select Subject</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}">{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="remove-subject-btn" onclick="removeSubject(this)">×</button>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="add-subject-btn" onclick="addSubject(7)">+ Add Subject</button>
                </div>
                </div>
            </form>
            <div class="schedule-form-footer">
                <button type="button" class="btn btn-primary" onclick="document.getElementById('schedule-update-form').submit()">{% if has_active_schedule %}Update Schedule{% else %}Create Schedule{% endif %}</button>
            </div>
        </div>
        </div>
        
        <!-- Weekly Schedule (Read-only) - only show if there's an active schedule -->
        {% if has_active_schedule %}
        <div class="current-schedule-section">
            <h3>Current Weekly Schedule</h3>
            <div class="schedule-grid">
                {% if schedule_by_day.1 %}
                <div class="day-column">
                    <h4>Monday</h4>
                    <div class="subjects-list">
                        {% for schedule_entry in schedule_by_day.1 %}
                        <div class="subject-item">{{ schedule_entry.subject.name }}</div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if schedule_by_day.2 %}
                <div class="day-column">
                    <h4>Tuesday</h4>
                    <div class="subjects-list">
                        {% for schedule_entry in schedule_by_day.2 %}
                        <div class="subject-item">{{ schedule_entry.subject.name }}</div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if schedule_by_day.3 %}
                <div class="day-column">
                    <h4>Wednesday</h4>
                    <div class="subjects-list">
                        {% for schedule_entry in schedule_by_day.3 %}
                        <div class="subject-item">{{ schedule_entry.subject.name }}</div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if schedule_by_day.4 %}
                <div class="day-column">
                    <h4>Thursday</h4>
                    <div class="subjects-list">
                        {% for schedule_entry in schedule_by_day.4 %}
                        <div class="subject-item">{{ schedule_entry.subject.name }}</div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if schedule_by_day.5 %}
                <div class="day-column">
                    <h4>Friday</h4>
                    <div class="subjects-list">
                        {% for schedule_entry in schedule_by_day.5 %}
                        <div class="subject-item">{{ schedule_entry.subject.name }}</div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if schedule_by_day.6 %}
                <div class="day-column">
                    <h4>Saturday</h4>
                    <div class="subjects-list">
                        {% for schedule_entry in schedule_by_day.6 %}
                        <div class="subject-item">{{ schedule_entry.subject.name }}</div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if schedule_by_day.7 %}
                <div class="day-column">
                    <h4>Sunday</h4>
                    <div class="subjects-list">
                        {% for schedule_entry in schedule_by_day.7 %}
                        <div class="subject-item">{{ schedule_entry.subject.name }}</div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Schedule Management (only show if there's an active schedule) -->
        {% if has_active_schedule %}
        <div class="schedule-management">
            <h3>Schedule Management</h3>
            <div class="schedule-actions">
                <form method="POST" action="{% url 'schedule_manage' %}" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="create_new">
                    <button type="submit" class="btn btn-primary">Create New Schedule</button>
                </form>
                <form method="POST" action="{% url 'schedule_manage' %}" style="display: inline; margin-left: 10px;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="disable_current">
                    <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete the current schedule?')">Delete Current Schedule</button>
                </form>
            </div>
        </div>
        {% endif %}
        </div>
        </div>
    </div>
</div>

<script>
// Set subjects data from Django template
window.availableSubjects = [
    {% for subject in subjects %}
    {id: {{ subject.id }}, name: "{{ subject.name|escapejs }}"}{% if not forloop.last %},{% endif %}
    {% endfor %}
];
console.log('Subjects loaded:', window.availableSubjects);
</script>

<script>
function toggleScheduleForm() {
    const content = document.getElementById('schedule-form-content');
    const toggleText = document.getElementById('toggle-text');
    const toggleIcon = document.getElementById('toggle-icon');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggleText.textContent = 'Hide';
        toggleIcon.textContent = '▲';
    } else {
        content.style.display = 'none';
        toggleText.textContent = 'Show';
        toggleIcon.textContent = '▼';
    }
}

function addSubject(dayNumber) {
    const subjectsList = document.getElementById(`subjects_${dayNumber}`);
    const subjectItem = document.createElement('div');
    subjectItem.className = 'subject-item';
    
    // Get the subjects data from the first select (if it exists)
    const firstSelect = subjectsList.querySelector('select');
    let subjectsOptions = '';
    if (firstSelect) {
        // Copy all options from existing select
        subjectsOptions = firstSelect.innerHTML;
    } else {
        // Fallback if no subjects exist yet - create basic structure
        subjectsOptions = '<option value="">Select Subject</option>';
    }
    
    subjectItem.innerHTML = `
        <select name="subjects_${dayNumber}" class="subject-select">
            ${subjectsOptions}
        </select>
        <button type="button" class="remove-subject-btn" onclick="removeSubject(this)">×</button>
    `;
    
    subjectsList.appendChild(subjectItem);
    
    // Ensure the new select has "Select Subject" as the default selected option
    const newSelect = subjectItem.querySelector('select');
    newSelect.value = '';
}

// Subjects and Books Management JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Force refresh the subjects and books data
    console.log('Page loaded, refreshing subjects and books...');
    
    // Clear any existing data first
    const tbody = document.getElementById('subjects-books-tbody');
    if (tbody) {
        tbody.innerHTML = '';
    }
    
    // Load fresh data
    loadSubjectsAndBooks();
    
    // Handle "Add New Subject" form submission
    const addSubjectForm = document.querySelector('form[action=""]');
    if (addSubjectForm) {
        addSubjectForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const subjectName = this.querySelector('input[name="subject_name"]').value.trim();
            if (subjectName) {
                addNewSubject(subjectName);
                this.reset();
            }
        });
    }
    
    // Handle "Add Book to Subject" form submission
    const addBookForm = document.querySelector('form[action=""]:not([onsubmit])');
    if (addBookForm && addBookForm !== addSubjectForm) {
        addBookForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const subjectId = this.querySelector('select[name="subject"]').value;
            const bookTitle = this.querySelector('input[name="book_title"]').value.trim();
            if (subjectId && bookTitle) {
                addNewBook(subjectId, bookTitle);
                this.reset();
            }
        });
    }
});

function addNewSubject(subjectName) {
    fetch('/api/subjects-books/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            action: 'create_subject',
            name: subjectName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadSubjectsAndBooks(); // Reload the table
            // Also update the subject dropdown in the schedule form
            updateSubjectDropdowns();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error adding subject:', error);
        alert('Error adding subject');
    });
}

function addNewBook(subjectId, bookTitle) {
    fetch('/api/subjects-books/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            action: 'create_book',
            subject_id: subjectId,
            title: bookTitle
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadSubjectsAndBooks(); // Reload the table
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error adding book:', error);
        alert('Error adding book');
    });
}

function updateSubjectDropdowns() {
    // Update all subject dropdowns in the schedule form
    fetch('/api/subjects-books/')
        .then(response => response.json())
        .then(data => {
            if (data.subjects) {
                const selects = document.querySelectorAll('select[name^="subjects_"]');
                selects.forEach(select => {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select Subject</option>';
                    data.subjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject.id;
                        option.textContent = subject.name;
                        select.appendChild(option);
                    });
                    select.value = currentValue;
                });
            }
        })
        .catch(error => {
            console.error('Error updating subject dropdowns:', error);
        });
}

function loadSubjectsAndBooks() {
    // Add multiple cache-busting parameters to ensure fresh data
    const timestamp = new Date().getTime();
    const random = Math.random();
    fetch(`/api/subjects-books/?t=${timestamp}&r=${random}&v=2`)
        .then(response => {
            console.log('API Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('API Response data:', data); // Debug logging
            if (data.subjects) {
                console.log('Subjects received:', data.subjects.length); // Debug logging
                console.log('Subject names:', data.subjects.map(s => s.name)); // Debug logging
                renderSubjectsAndBooks(data.subjects);
            } else {
                console.log('No subjects in response');
            }
        })
        .catch(error => {
            console.error('Error loading subjects and books:', error);
        });
}

function renderSubjectsAndBooks(subjects) {
    const tbody = document.getElementById('subjects-books-tbody');
    // Clear the table completely
    tbody.innerHTML = '';
    
    console.log('Rendering subjects:', subjects.length); // Debug logging
    
    subjects.forEach(subject => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="subject-cell">
                <span class="subject-name" id="subject-name-${subject.id}" onclick="toggleSubjectRename(${subject.id})" style="cursor: pointer;">${subject.name}</span>
                <input type="text" class="subject-rename-input" id="subject-input-${subject.id}" value="${subject.name}" style="display: none;">
            </td>
            <td class="books-cell" id="books-cell-${subject.id}">
                ${renderBooks(subject.books)}
            </td>
            <td class="actions-cell">
                <button class="action-btn delete" onclick="deleteSubject(${subject.id})">Delete</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function renderBooks(books) {
    if (books.length === 0) {
        return '<span class="text-muted">No books</span>';
    }
    
    return books.map(book => `
        <span class="book-item" id="book-item-${book.id}">
            <span class="book-title" id="book-title-${book.id}" onclick="toggleBookRename(${book.id})" style="cursor: pointer;">${book.title}</span>
            <input type="text" class="book-rename-input" id="book-input-${book.id}" value="${book.title}" style="display: none;">
            <button class="book-delete-btn" onclick="deleteBook(${book.id})" title="Delete book">×</button>
        </span>
    `).join('');
}

function toggleSubjectRename(subjectId) {
    const nameSpan = document.getElementById(`subject-name-${subjectId}`);
    const inputField = document.getElementById(`subject-input-${subjectId}`);
    
    if (nameSpan.style.display !== 'none') {
        // Switch to edit mode
        nameSpan.style.display = 'none';
        inputField.style.display = 'inline-block';
        inputField.focus();
        inputField.select();
    } else {
        // Save changes
        const newName = inputField.value.trim();
        if (newName && newName !== nameSpan.textContent) {
            renameSubject(subjectId, newName);
        } else {
            // Cancel edit
            nameSpan.style.display = 'inline';
            inputField.style.display = 'none';
        }
    }
}

function toggleBookRename(bookId) {
    const titleSpan = document.getElementById(`book-title-${bookId}`);
    const inputField = document.getElementById(`book-input-${bookId}`);
    
    if (titleSpan.style.display !== 'none') {
        // Switch to edit mode
        titleSpan.style.display = 'none';
        inputField.style.display = 'inline-block';
        inputField.focus();
        inputField.select();
    } else {
        // Save changes
        const newTitle = inputField.value.trim();
        if (newTitle && newTitle !== titleSpan.textContent) {
            renameBook(bookId, newTitle);
        } else {
            // Cancel edit
            titleSpan.style.display = 'inline';
            inputField.style.display = 'none';
        }
    }
}

function renameSubject(subjectId, newName) {
    fetch('/api/subjects-books/', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            action: 'rename_subject',
            id: subjectId,
            name: newName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const nameSpan = document.getElementById(`subject-name-${subjectId}`);
            const inputField = document.getElementById(`subject-input-${subjectId}`);
            
            nameSpan.textContent = data.name;
            nameSpan.style.display = 'inline';
            inputField.style.display = 'none';
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error renaming subject:', error);
        alert('Error renaming subject');
    });
}

function renameBook(bookId, newTitle) {
    fetch('/api/subjects-books/', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            action: 'rename_book',
            id: bookId,
            title: newTitle
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const titleSpan = document.getElementById(`book-title-${bookId}`);
            const inputField = document.getElementById(`book-input-${bookId}`);
            
            titleSpan.textContent = data.title;
            titleSpan.style.display = 'inline';
            inputField.style.display = 'none';
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error renaming book:', error);
        alert('Error renaming book');
    });
}

function deleteSubject(subjectId) {
    if (confirm('Are you sure you want to delete this subject? This will also delete all associated books.')) {
        fetch('/api/subjects-books/', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                action: 'delete_subject',
                id: subjectId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadSubjectsAndBooks(); // Reload the table
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error deleting subject:', error);
            alert('Error deleting subject');
        });
    }
}

function deleteBook(bookId) {
    if (confirm('Are you sure you want to delete this book?')) {
        fetch('/api/subjects-books/', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                action: 'delete_book',
                id: bookId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadSubjectsAndBooks(); // Reload the table
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error deleting book:', error);
            alert('Error deleting book');
        });
    }
}

// Handle Enter key in rename inputs
document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        const input = e.target;
        if (input.classList.contains('subject-rename-input')) {
            const subjectId = input.id.replace('subject-input-', '');
            toggleSubjectRename(parseInt(subjectId));
        } else if (input.classList.contains('book-rename-input')) {
            const bookId = input.id.replace('book-input-', '');
            toggleBookRename(parseInt(bookId));
        }
    }
});

// Handle Escape key to cancel rename
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const input = e.target;
        if (input.classList.contains('subject-rename-input')) {
            const subjectId = input.id.replace('subject-input-', '');
            const nameSpan = document.getElementById(`subject-name-${subjectId}`);
            const inputField = document.getElementById(`subject-input-${subjectId}`);
            
            nameSpan.style.display = 'inline';
            inputField.style.display = 'none';
        } else if (input.classList.contains('book-rename-input')) {
            const bookId = input.id.replace('book-input-', '');
            const titleSpan = document.getElementById(`book-title-${bookId}`);
            const inputField = document.getElementById(`book-input-${bookId}`);
            
            titleSpan.style.display = 'inline';
            inputField.style.display = 'none';
        }
    }
});

// Function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


function removeSubject(button) {
    const subjectItem = button.parentElement;
    const subjectsList = subjectItem.parentElement;
    
    // Don't remove if it's the last subject item
    if (subjectsList.children.length > 1) {
        subjectItem.remove();
    } else {
        // If it's the last one, just clear the selection
        const select = subjectItem.querySelector('select');
        select.value = '';
    }
}

// Date formatting functions
function formatDateToDDMMYYYY(date) {
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}.${month}.${year}`;
}

function parseDDMMYYYYToDate(dateStr) {
    const parts = dateStr.split('.');
    if (parts.length === 3) {
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1; // JavaScript months are 0-based
        const year = parseInt(parts[2], 10);
        return new Date(year, month, day);
    }
    return null;
}

// Calendar and subject selection variables
let currentCalendarDate = new Date();
let selectedDate = null;
let selectedSubject = null;

// Test management functions
function addTestEntry() {
    const testEntries = document.getElementById('test-entries');
    const newEntry = document.createElement('div');
    newEntry.className = 'test-entry';
    
    newEntry.innerHTML = `
        <div class="test-selection-container">
            <div class="date-selection">
                <label class="selection-label">Select Date:</label>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button type="button" class="calendar-nav-btn" onclick="changeMonth(-1)">‹</button>
                        <span class="calendar-month-year" id="calendar-month-year-${Date.now()}"></span>
                        <button type="button" class="calendar-nav-btn" onclick="changeMonth(1)">›</button>
                    </div>
                    <div class="calendar-grid" id="calendar-grid-${Date.now()}">
                        <!-- Calendar will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="selected-tests-container">
                <label class="selection-label">Selected Tests:</label>
                <div class="selected-tests-list" id="selected-tests-list-${Date.now()}">
                    <!-- Selected tests will appear here as labels -->
                </div>
            </div>
        </div>
        <div class="test-entry-actions">
            <button type="button" class="remove-test-btn" onclick="removeTestEntry(this)">×</button>
        </div>
    `;
    
    testEntries.appendChild(newEntry);
    
    // Initialize calendar for this entry
    initializeCalendar(newEntry);
    
    // Show remove buttons for all entries if there's more than one
    updateTestRemoveButtons();
}

function removeTestEntry(button) {
    const testEntry = button.closest('.test-entry');
    testEntry.remove();
    
    // Update remove button visibility
    updateTestRemoveButtons();
}

function updateTestRemoveButtons() {
    const testEntries = document.getElementById('test-entries');
    const entries = testEntries.querySelectorAll('.test-entry');
    const removeButtons = testEntries.querySelectorAll('.remove-test-btn');
    
    // Show remove buttons only if there's more than one entry
    removeButtons.forEach(button => {
        button.style.display = entries.length > 1 ? 'inline-block' : 'none';
    });
}

// Calendar functions
function initializeCalendar(testEntry) {
    console.log('Initializing calendar');
    const calendarGrid = testEntry.querySelector('.calendar-grid');
    const monthYearSpan = testEntry.querySelector('.calendar-month-year');
    
    console.log('Calendar grid:', calendarGrid);
    console.log('Month year span:', monthYearSpan);
    
    if (!calendarGrid) {
        console.error('Calendar grid not found!');
        return;
    }
    
    if (!monthYearSpan) {
        console.error('Month year span not found!');
        return;
    }
    
    // Set current month/year
    updateCalendarDisplay(monthYearSpan);
    renderCalendar(calendarGrid, testEntry);
    console.log('Calendar initialized successfully');
}

function changeMonth(direction) {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
    
    // Update all calendar displays
    const monthYearSpans = document.querySelectorAll('.calendar-month-year');
    const calendarGrids = document.querySelectorAll('.calendar-grid');
    
    monthYearSpans.forEach(span => updateCalendarDisplay(span));
    calendarGrids.forEach((grid, index) => {
        const testEntry = grid.closest('.test-entry');
        renderCalendar(grid, testEntry);
    });
}

function updateCalendarDisplay(monthYearSpan) {
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    monthYearSpan.textContent = `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
}

function renderCalendar(calendarGrid, testEntry) {
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    
    // Clear previous content
    calendarGrid.innerHTML = '';
    
    // Add day headers
    const dayHeaders = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    dayHeaders.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'calendar-day-header';
        dayHeader.textContent = day;
        calendarGrid.appendChild(dayHeader);
    });
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startDay = (firstDay.getDay() + 6) % 7; // Convert Sunday=0 to Monday=0
    
    // Add empty cells for days before month starts
    for (let i = 0; i < startDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'calendar-day empty';
        calendarGrid.appendChild(emptyCell);
    }
    
    // Add days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-day';
        dayCell.textContent = day;
        dayCell.dataset.day = day;
        dayCell.dataset.month = month;
        dayCell.dataset.year = year;
        
        // Add click handler
        dayCell.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent event bubbling
            console.log('Day cell clicked:', this.textContent);
            console.log('testEntry for click:', testEntry);
            selectDate(this, testEntry);
        });
        
        console.log('Click handler added to day:', day);
        
        // Highlight today
        const today = new Date();
        if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
            dayCell.classList.add('today');
        }
        
        calendarGrid.appendChild(dayCell);
    }
    
}

function selectDate(dayElement, testEntry) {
    console.log('selectDate called with day:', dayElement.textContent);
    console.log('testEntry:', testEntry);
    
    // Remove previous selection
    const calendarGrid = testEntry.querySelector('.calendar-grid');
    if (calendarGrid) {
        calendarGrid.querySelectorAll('.calendar-day.selected').forEach(day => {
            day.classList.remove('selected');
        });
    }
    
    // Add selection to clicked day
    dayElement.classList.add('selected');
    
    // Get selected date
    const day = parseInt(dayElement.dataset.day);
    const month = parseInt(dayElement.dataset.month);
    const year = parseInt(dayElement.dataset.year);
    const selectedDate = new Date(year, month, day);
    
    // Store selected date in test entry
    testEntry.dataset.selectedDate = formatDateToDDMMYYYY(selectedDate);
    console.log('Selected date stored:', testEntry.dataset.selectedDate);
    
    // Show subject dropdown for this date
    console.log('About to call showSubjectDropdown');
    showSubjectDropdown(dayElement, testEntry);
    console.log('showSubjectDropdown called');
}

function showSubjectDropdown(dayElement, testEntry) {
    console.log('showSubjectDropdown called');
    // Remove any existing dropdown
    hideSubjectDropdown();
    
    // Get subjects data from global variable
    const subjects = window.availableSubjects || [];
    console.log('Available subjects:', subjects);
    
    if (subjects.length === 0) {
        console.log('No subjects available, returning');
        return;
    }
    
    // Create dropdown
    const dropdown = document.createElement('div');
    dropdown.className = 'subject-dropdown';
    dropdown.id = 'subject-dropdown';
    
    // Remove inline styles to use CSS classes
    // The CSS will handle all styling
    
    const dropdownContent = document.createElement('div');
    dropdownContent.className = 'subject-dropdown-content';
    dropdownContent.style.padding = '8px 0';
    
    subjects.forEach(subject => {
        const option = document.createElement('div');
        option.className = 'subject-dropdown-option';
        option.textContent = subject.name;
        option.dataset.subjectId = subject.id;
        option.dataset.subjectName = subject.name;
        
        // Use CSS classes for styling
        
        option.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent event bubbling
            selectSubjectFromDropdown(this, testEntry, dayElement);
        });
        
        // Hover effects handled by CSS
        
        dropdownContent.appendChild(option);
    });
    
    dropdown.appendChild(dropdownContent);
    
    // Position dropdown near the clicked day
    const rect = dayElement.getBoundingClientRect();
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
    
    dropdown.style.position = 'absolute';
    dropdown.style.left = (rect.left + scrollLeft) + 'px';
    dropdown.style.top = (rect.bottom + scrollTop + 5) + 'px';
    dropdown.style.zIndex = '1000';
    dropdown.style.display = 'block'; // Ensure it's visible
    dropdown.style.visibility = 'visible'; // Ensure it's visible
    
    console.log('Dropdown positioned at:', rect.left + scrollLeft, rect.bottom + scrollTop + 5);
    console.log('Dropdown element:', dropdown);
    console.log('Dropdown computed style:', window.getComputedStyle(dropdown));
    
    // Add click event to prevent dropdown from closing when clicking on it
    dropdown.addEventListener('click', function(e) {
        e.stopPropagation();
    });
    
    document.body.appendChild(dropdown);
    console.log('Dropdown added to DOM');
    console.log('Dropdown final position:', dropdown.getBoundingClientRect());
    
    // Close dropdown when clicking outside
    setTimeout(() => {
        document.addEventListener('click', function hideDropdownOnOutsideClick(e) {
            if (!dropdown.contains(e.target)) {
                hideSubjectDropdown();
                document.removeEventListener('click', hideDropdownOnOutsideClick);
            }
        });
    }, 100);
}

function hideSubjectDropdown() {
    const dropdown = document.getElementById('subject-dropdown');
    if (dropdown) {
        dropdown.remove();
    }
    // Remove all click event listeners that might be related to dropdown hiding
    document.removeEventListener('click', hideSubjectDropdown);
}

function selectSubjectFromDropdown(optionElement, testEntry, dayElement) {
    const subjectId = optionElement.dataset.subjectId;
    const subjectName = optionElement.dataset.subjectName;
    const selectedDate = testEntry.dataset.selectedDate;
    
    // Create test label
    createTestLabel(testEntry, selectedDate, subjectName, subjectId);
    
    // Hide dropdown
    hideSubjectDropdown();
    
    // Save test to server and add chip immediately
    saveTestToServer(selectedDate, subjectId, subjectName);
}

function createTestLabel(testEntry, date, subjectName, subjectId) {
    const selectedTestsList = testEntry.querySelector('.selected-tests-list');
    
    const label = document.createElement('div');
    label.className = 'test-label';
    label.dataset.date = date;
    label.dataset.subjectId = subjectId;
    label.innerHTML = `
        <span class="test-label-text">${subjectName} (${date})</span>
        <button type="button" class="test-label-remove" onclick="removeTestLabel(this)">×</button>
    `;
    
    selectedTestsList.appendChild(label);
}

function removeTestLabel(button) {
    const label = button.closest('.test-label');
    const date = label.dataset.date;
    const subjectId = label.dataset.subjectId;
    
    // Convert date back to server format for deletion
    const dateObj = parseDDMMYYYYToDate(date);
    if (dateObj) {
        const serverDate = dateObj.toISOString().split('T')[0];
        deleteTestFromServer(serverDate, subjectId);
    }
    
    // Remove the corresponding test chip
    const chipsContainer = document.getElementById('test-chips');
    const correspondingChip = chipsContainer.querySelector(`.test-chip[data-date="${date}"][data-subject-id="${subjectId}"]`);
    if (correspondingChip) {
        correspondingChip.remove();
    }
    
    label.remove();
}

function openDatePicker(dateInput) {
    // Create a temporary date input for the native date picker
    const tempInput = document.createElement('input');
    tempInput.type = 'date';
    tempInput.style.position = 'absolute';
    tempInput.style.left = '-9999px';
    tempInput.style.opacity = '0';
    
    // Set current value if exists
    const currentValue = dateInput.value;
    if (currentValue) {
        const dateObj = parseDDMMYYYYToDate(currentValue);
        if (dateObj) {
            tempInput.value = dateObj.toISOString().split('T')[0];
        }
    } else {
        // Set today's date as default
        const today = new Date();
        tempInput.value = today.toISOString().split('T')[0];
    }
    
    document.body.appendChild(tempInput);
    
    // Focus and click the temporary input
    tempInput.focus();
    tempInput.click();
    
    // Handle the change event
    tempInput.addEventListener('change', function() {
        if (tempInput.value) {
            // Parse the date string directly to avoid timezone issues
            const [year, month, day] = tempInput.value.split('-').map(Number);
            const selectedDate = new Date(year, month - 1, day);
            dateInput.value = formatDateToDDMMYYYY(selectedDate);
            
            // Trigger save if subject is also selected
            const subjectSelect = dateInput.closest('.test-entry').querySelector('.test-subject-select');
            if (subjectSelect.value) {
                saveTestToServer(dateInput.value, subjectSelect.value);
            }
        }
        
        // Clean up
        document.body.removeChild(tempInput);
    });
    
    // Clean up if user clicks outside
    setTimeout(() => {
        if (document.body.contains(tempInput)) {
            document.body.removeChild(tempInput);
        }
    }, 10000);
}

function saveTestToServer(date, subjectId, subjectName = null) {
    // Convert dd.mm.yyyy to yyyy-mm-dd for server using local timezone
    const dateObj = parseDDMMYYYYToDate(date);
    if (!dateObj) {
        showTestMessage('Invalid date format', 'error');
        return;
    }
    
    // Use local timezone methods to avoid date shifting
    const year = dateObj.getFullYear();
    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
    const day = String(dateObj.getDate()).padStart(2, '0');
    const serverDate = `${year}-${month}-${day}`;
    
    fetch('{% if is_admin_view %}{% url "home_user" target_user.username target_user.id %}{% else %}{% url "home" %}{% endif %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `action=add_tests&test_date=${encodeURIComponent(serverDate)}&test_subject=${encodeURIComponent(subjectId)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add the test as a chip with subject name
            addTestChip(date, subjectId, subjectName);
        } else {
            console.error('Save failed:', data.error);
        }
    })
    .catch(error => {
        console.error('Error saving test:', error);
    });
}

function showTestMessage(message, type) {
    // Create or update message element
    let messageEl = document.getElementById('test-message');
    if (!messageEl) {
        messageEl = document.createElement('div');
        messageEl.id = 'test-message';
        messageEl.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transition: opacity 0.3s ease;
        `;
        document.body.appendChild(messageEl);
    }
    
    messageEl.textContent = message;
    messageEl.style.backgroundColor = type === 'success' ? '#28a745' : '#dc3545';
    messageEl.style.opacity = '1';
    
    // Hide message after 3 seconds
    setTimeout(() => {
        messageEl.style.opacity = '0';
    }, 3000);
}

// Chip management functions
function addTestChip(date, subjectId, subjectName = null) {
    const chipsContainer = document.getElementById('test-chips');
    
    // Get subject name if not provided
    if (!subjectName) {
        const subjectSelect = document.querySelector('.test-subject-select');
        if (subjectSelect) {
            const option = subjectSelect.querySelector(`option[value="${subjectId}"]`);
            subjectName = option ? option.textContent : 'Unknown Subject';
        } else {
            subjectName = 'Unknown Subject';
        }
    }
    
    const chip = document.createElement('div');
    chip.className = 'test-chip';
    chip.dataset.date = date;
    chip.dataset.subjectId = subjectId;
    chip.innerHTML = `
        <span class="chip-text">${subjectName} (<strong>${date}</strong>)</span>
        <button type="button" class="chip-remove" onclick="removeTestChip(this)">×</button>
    `;
    
    chipsContainer.appendChild(chip);
    
    // Clear the form
    clearTestForm();
}

function removeTestChip(button) {
    const chip = button.closest('.test-chip');
    const date = chip.dataset.date;
    const subjectId = chip.dataset.subjectId;
    
    console.log('Removing test chip:', { date, subjectId });
    
    // Convert date back to server format for deletion
    const dateObj = parseDDMMYYYYToDate(date);
    if (dateObj) {
        // Use UTC methods to avoid timezone issues
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        const serverDate = `${year}-${month}-${day}`;
        console.log('Server date format:', serverDate);
        
        // Delete from server first, then remove from DOM
        deleteTestFromServer(serverDate, subjectId, chip);
    } else {
        console.error('Invalid date format:', date);
    }
}

function deleteTestFromServer(date, subjectId, chip) {
    console.log('Sending delete request:', { date, subjectId });
    
    fetch('{% if is_admin_view %}{% url "home_user" target_user.username target_user.id %}{% else %}{% url "home" %}{% endif %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `action=delete_test&test_date=${encodeURIComponent(date)}&test_subject=${encodeURIComponent(subjectId)}`
    })
    .then(response => response.json())
    .then(data => {
        console.log('Delete response:', data);
        if (data.success) {
            // Remove from DOM only after successful server deletion
            const originalDate = chip.dataset.date;
            
            // Remove the corresponding test label
            const testEntries = document.getElementById('test-entries');
            const correspondingLabel = testEntries.querySelector(`.test-label[data-date="${originalDate}"][data-subject-id="${subjectId}"]`);
            if (correspondingLabel) {
                correspondingLabel.remove();
            }
            
            // Remove the chip
            chip.remove();
        } else {
            console.error('Delete failed:', data.error);
        }
    })
    .catch(error => {
        console.error('Error deleting test:', error);
    });
}

function clearTestForm() {
    const dateInput = document.querySelector('.test-date-input');
    const subjectSelect = document.querySelector('.test-subject-select');
    
    if (dateInput) {
        const today = new Date();
        dateInput.value = formatDateToDDMMYYYY(today);
    }
    if (subjectSelect) {
        subjectSelect.value = '';
    }
}

// Initialize the first test entry with calendar
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded');
    console.log('Available subjects:', window.availableSubjects);
    
    // Initialize calendar for the first entry
    const firstTestEntry = document.querySelector('.test-entry');
    if (firstTestEntry) {
        console.log('First test entry found, initializing calendar');
        initializeCalendar(firstTestEntry);
    } else {
        console.log('No test entry found');
    }
    
    // Load existing tests as chips
    loadExistingTests();
});

function loadExistingTests() {
    // Load existing tests from the server and display them as chips
    fetch('{% if is_admin_view %}{% url "home_user" target_user.username target_user.id %}{% else %}{% url "home" %}{% endif %}', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.tests) {
            data.tests.forEach(test => {
                const dateStr = formatDateToDDMMYYYY(new Date(test.date));
                addTestChip(dateStr, test.subject_id, test.subject_name);
            });
        }
    })
    .catch(error => {
        console.error('Error loading existing tests:', error);
    });
}
</script>
{% endblock %}