{% extends "mobile_base.html" %}

{% block title %}Weekly Program - School Organizer{% endblock %}

{% block content %}
<div class="mobile-container">
    {% if is_admin_view %}
    <div class="mobile-admin-notice">
        <h2>Managing {{ target_user.username }}'s Program</h2>
        <p>You are managing {{ target_user.username }}'s subjects and schedule.</p>
        <a href="{% url 'users' %}" class="mobile-back-btn">← Back to Users</a>
    </div>
    {% else %}
    <h2 class="mobile-page-title">Weekly Program</h2>
    {% endif %}
    
    <!-- Mobile User Alias Management -->
    {% if not is_admin_view %}
    <div class="mobile-form-card">
        <h3>Add Display Name</h3>
        <form method="POST" action="{% url 'home' %}" class="mobile-alias-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_alias">
            <div class="mobile-form-group">
                <label for="alias">Display Name:</label>
                <input type="text" name="alias" id="alias" value="{{ user.alias|default:'' }}" placeholder="Enter your display name (optional)">
            </div>
            <button type="submit" class="mobile-btn mobile-btn-primary">Update</button>
        </form>
        <p class="mobile-alias-help">This name will be displayed in the history page instead of your username.</p>
    </div>
    {% endif %}
    
    {% if user.is_admin or user.is_teacher %}
    <!-- Mobile Forms Section -->
    <div class="mobile-forms-section">
        <div class="mobile-form-card">
            <h3>Add New Subject</h3>
            <form method="POST" action="{% if is_admin_view %}{% url 'home_user' target_user.username target_user.id %}{% else %}{% url 'home' %}{% endif %}">
                {% csrf_token %}
                <div class="mobile-form-group">
                    <label for="subject_name">Subject Name:</label>
                    <input type="text" name="subject_name" id="subject_name" placeholder="Enter subject name" required>
                </div>
                <button type="submit" class="mobile-btn mobile-btn-primary">Add Subject</button>
            </form>
        </div>
        
        <div class="mobile-form-card">
            <h3>Add Book to Subject</h3>
            <form method="POST" action="{% if is_admin_view %}{% url 'home_user' target_user.username target_user.id %}{% else %}{% url 'home' %}{% endif %}">
                {% csrf_token %}
                <div class="mobile-form-group">
                    <label for="subject_id">Select Subject:</label>
                    <select name="subject_id" id="subject_id" required>
                        <option value="">Choose a subject...</option>
                        {% for subject in subjects %}
                        <option value="{{ subject.id }}">{{ subject.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mobile-form-group">
                    <label for="book_title">Book Title:</label>
                    <input type="text" name="book_title" id="book_title" placeholder="Enter book title" required>
                </div>
                <button type="submit" class="mobile-btn mobile-btn-primary">Add Book</button>
            </form>
        </div>
    </div>
    
    <!-- Mobile Subjects Management -->
    <div class="mobile-management-section">
        <div class="mobile-section-header" onclick="toggleMobileSection('subjects-books')">
            <h3>Subjects & Books</h3>
            <span class="mobile-toggle-icon" id="mobile-toggle-subjects-books">▼</span>
        </div>
        <div class="mobile-section-content" id="mobile-content-subjects-books" style="display: none;">
            <div class="mobile-info">
                {{ user.username }} ({{ user.get_role_display }})
            </div>
            <div class="mobile-subjects-container" id="subjects-books-container">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Mobile Add Test Section -->
    <div class="mobile-management-section">
        <div class="mobile-section-header" onclick="toggleMobileSection('add-test')">
            <h3>Add Test</h3>
            <span class="mobile-toggle-icon" id="mobile-toggle-add-test">▼</span>
        </div>
        <div class="mobile-section-content" id="mobile-content-add-test" style="display: none;">
            <div class="mobile-test-chips-container" id="mobile-test-chips">
                <!-- Saved tests will appear as chips here -->
            </div>
            <div class="mobile-test-form">
                <form method="POST" action="{% url 'home' %}" id="mobile-test-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_tests">
                    <div class="mobile-form-group">
                        <label for="mobile_test_date">Test Date:</label>
                        <div class="mobile-date-input-wrapper" onclick="openMobileDatePicker()">
                            <input type="date" name="test_date" id="mobile_test_date" required style="position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 1; top: 0; left: 0;" data-firstdayofweek="1">
                            <div class="mobile-date-display" id="mobile-date-display">Select Date</div>
                        </div>
                    </div>
                    <div class="mobile-form-group">
                        <label for="mobile_test_subject">Subject:</label>
                        <select name="test_subject" id="mobile_test_subject" required>
                            <option value="">Choose a subject...</option>
                            {% for subject in subjects %}
                            <option value="{{ subject.id }}">{{ subject.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="mobile-btn mobile-btn-primary">Save Test</button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
    
    
    <!-- Mobile Schedule Form -->
    <div class="mobile-schedule-form-section">
        <div class="mobile-schedule-header" onclick="toggleMobileScheduleForm()">
            <h3>{% if has_active_schedule %}Edit Schedule{% else %}Create Schedule{% endif %}</h3>
            <span class="mobile-toggle-icon" id="mobile-toggle-icon">▼</span>
        </div>
        <div class="mobile-schedule-content" id="mobile-schedule-content" style="display: none;">
            <form id="mobile-schedule-form" method="POST" action="{% if is_admin_view %}{% url 'home_user' target_user.username target_user.id %}{% else %}{% url 'home' %}{% endif %}">
                {% csrf_token %}
                <input type="hidden" name="update_schedule" value="1">
                
                <!-- Mobile Schedule Days -->
                <div class="mobile-schedule-days">
                    <div class="mobile-day-section">
                        <h4>Monday</h4>
                        <div class="mobile-subjects-list" id="mobile_subjects_1">
                            {% for schedule_entry in schedule_by_day.1 %}
                            <div class="mobile-subject-item">
                                <select name="subjects_1" class="mobile-subject-select">
                                    <option value="">Select Subject</option>
                                    {% for subject in subjects %}
                                    <option value="{{ subject.id }}" {% if schedule_entry.subject.id == subject.id %}selected{% endif %}>{{ subject.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="mobile-remove-btn" onclick="removeMobileSubject(this)">×</button>
                            </div>
                            {% empty %}
                            <div class="mobile-subject-item">
                                <select name="subjects_1" class="mobile-subject-select">
                                    <option value="">Select Subject</option>
                                    {% for subject in subjects %}
                                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="mobile-remove-btn" onclick="removeMobileSubject(this)">×</button>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="mobile-add-btn" onclick="addMobileSubject(1)">+ Add Subject</button>
                    </div>
                    
                    <div class="mobile-day-section">
                        <h4>Tuesday</h4>
                        <div class="mobile-subjects-list" id="mobile_subjects_2">
                            {% for schedule_entry in schedule_by_day.2 %}
                            <div class="mobile-subject-item">
                                <select name="subjects_2" class="mobile-subject-select">
                                    <option value="">Select Subject</option>
                                    {% for subject in subjects %}
                                    <option value="{{ subject.id }}" {% if schedule_entry.subject.id == subject.id %}selected{% endif %}>{{ subject.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="mobile-remove-btn" onclick="removeMobileSubject(this)">×</button>
                            </div>
                            {% empty %}
                            <div class="mobile-subject-item">
                                <select name="subjects_2" class="mobile-subject-select">
                                    <option value="">Select Subject</option>
                                    {% for subject in subjects %}
                                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="mobile-remove-btn" onclick="removeMobileSubject(this)">×</button>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="mobile-add-btn" onclick="addMobileSubject(2)">+ Add Subject</button>
                    </div>
                    
                    <div class="mobile-day-section">
                        <h4>Wednesday</h4>
                        <div class="mobile-subjects-list" id="mobile_subjects_3">
                            {% for schedule_entry in schedule_by_day.3 %}
                            <div class="mobile-subject-item">
                                <select name="subjects_3" class="mobile-subject-select">
                                    <option value="">Select Subject</option>
                                    {% for subject in subjects %}
                                    <option value="{{ subject.id }}" {% if schedule_entry.subject.id == subject.id %}selected{% endif %}>{{ subject.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="mobile-remove-btn" onclick="removeMobileSubject(this)">×</button>
                            </div>
                            {% empty %}
                            <div class="mobile-subject-item">
                                <select name="subjects_3" class="mobile-subject-select">
                                    <option value="">Select Subject</option>
                                    {% for subject in subjects %}
                                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="mobile-remove-btn" onclick="removeMobileSubject(this)">×</button>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="mobile-add-btn" onclick="addMobileSubject(3)">+ Add Subject</button>
                    </div>
                    
                    <div class="mobile-day-section">
                        <h4>Thursday</h4>
                        <div class="mobile-subjects-list" id="mobile_subjects_4">
                            {% for schedule_entry in schedule_by_day.4 %}
                            <div class="mobile-subject-item">
                                <select name="subjects_4" class="mobile-subject-select">
                                    <option value="">Select Subject</option>
                                    {% for subject in subjects %}
                                    <option value="{{ subject.id }}" {% if schedule_entry.subject.id == subject.id %}selected{% endif %}>{{ subject.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="mobile-remove-btn" onclick="removeMobileSubject(this)">×</button>
                            </div>
                            {% empty %}
                            <div class="mobile-subject-item">
                                <select name="subjects_4" class="mobile-subject-select">
                                    <option value="">Select Subject</option>
                                    {% for subject in subjects %}
                                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="mobile-remove-btn" onclick="removeMobileSubject(this)">×</button>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="mobile-add-btn" onclick="addMobileSubject(4)">+ Add Subject</button>
                    </div>
                    
                    <div class="mobile-day-section">
                        <h4>Friday</h4>
                        <div class="mobile-subjects-list" id="mobile_subjects_5">
                            {% for schedule_entry in schedule_by_day.5 %}
                            <div class="mobile-subject-item">
                                <select name="subjects_5" class="mobile-subject-select">
                                    <option value="">Select Subject</option>
                                    {% for subject in subjects %}
                                    <option value="{{ subject.id }}" {% if schedule_entry.subject.id == subject.id %}selected{% endif %}>{{ subject.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="mobile-remove-btn" onclick="removeMobileSubject(this)">×</button>
                            </div>
                            {% empty %}
                            <div class="mobile-subject-item">
                                <select name="subjects_5" class="mobile-subject-select">
                                    <option value="">Select Subject</option>
                                    {% for subject in subjects %}
                                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="mobile-remove-btn" onclick="removeMobileSubject(this)">×</button>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="mobile-add-btn" onclick="addMobileSubject(5)">+ Add Subject</button>
                    </div>
                    
                    <div class="mobile-day-section">
                        <h4>Saturday</h4>
                        <div class="mobile-subjects-list" id="mobile_subjects_6">
                            {% for schedule_entry in schedule_by_day.6 %}
                            <div class="mobile-subject-item">
                                <select name="subjects_6" class="mobile-subject-select">
                                    <option value="">Select Subject</option>
                                    {% for subject in subjects %}
                                    <option value="{{ subject.id }}" {% if schedule_entry.subject.id == subject.id %}selected{% endif %}>{{ subject.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="mobile-remove-btn" onclick="removeMobileSubject(this)">×</button>
                            </div>
                            {% empty %}
                            <div class="mobile-subject-item">
                                <select name="subjects_6" class="mobile-subject-select">
                                    <option value="">Select Subject</option>
                                    {% for subject in subjects %}
                                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="mobile-remove-btn" onclick="removeMobileSubject(this)">×</button>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="mobile-add-btn" onclick="addMobileSubject(6)">+ Add Subject</button>
                    </div>
                    
                    <div class="mobile-day-section">
                        <h4>Sunday</h4>
                        <div class="mobile-subjects-list" id="mobile_subjects_7">
                            {% for schedule_entry in schedule_by_day.7 %}
                            <div class="mobile-subject-item">
                                <select name="subjects_7" class="mobile-subject-select">
                                    <option value="">Select Subject</option>
                                    {% for subject in subjects %}
                                    <option value="{{ subject.id }}" {% if schedule_entry.subject.id == subject.id %}selected{% endif %}>{{ subject.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="mobile-remove-btn" onclick="removeMobileSubject(this)">×</button>
                            </div>
                            {% empty %}
                            <div class="mobile-subject-item">
                                <select name="subjects_7" class="mobile-subject-select">
                                    <option value="">Select Subject</option>
                                    {% for subject in subjects %}
                                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="mobile-remove-btn" onclick="removeMobileSubject(this)">×</button>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="mobile-add-btn" onclick="addMobileSubject(7)">+ Add Subject</button>
                    </div>
                </div>
            </form>
            <div class="mobile-schedule-footer">
                <button type="button" class="mobile-btn mobile-btn-primary" onclick="document.getElementById('mobile-schedule-form').submit()">
                    {% if has_active_schedule %}Update Schedule{% else %}Create Schedule{% endif %}
                </button>
            </div>
        </div>
    </div>
    
    <!-- Mobile Current Schedule Display -->
    {% if has_active_schedule %}
    <div class="mobile-current-schedule">
        <div class="mobile-schedule-header" onclick="toggleMobileSection('current-schedule')">
            <h3>Current Schedule</h3>
            <span class="mobile-toggle-icon" id="mobile-toggle-current-schedule">▼</span>
        </div>
        <div class="mobile-section-content" id="mobile-content-current-schedule" style="display: none;">
            <div class="mobile-schedule-display">
                <div class="mobile-day-display">
                    <h4>Monday</h4>
                    <div class="mobile-subjects-display">
                        {% for schedule_entry in schedule_by_day.1 %}
                        <div class="mobile-subject-numbered">{{ forloop.counter }}. {{ schedule_entry.subject.name }}</div>
                        {% empty %}
                        <span class="mobile-no-subjects">No subjects</span>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="mobile-day-display">
                    <h4>Tuesday</h4>
                    <div class="mobile-subjects-display">
                        {% for schedule_entry in schedule_by_day.2 %}
                        <div class="mobile-subject-numbered">{{ forloop.counter }}. {{ schedule_entry.subject.name }}</div>
                        {% empty %}
                        <span class="mobile-no-subjects">No subjects</span>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="mobile-day-display">
                    <h4>Wednesday</h4>
                    <div class="mobile-subjects-display">
                        {% for schedule_entry in schedule_by_day.3 %}
                        <div class="mobile-subject-numbered">{{ forloop.counter }}. {{ schedule_entry.subject.name }}</div>
                        {% empty %}
                        <span class="mobile-no-subjects">No subjects</span>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="mobile-day-display">
                    <h4>Thursday</h4>
                    <div class="mobile-subjects-display">
                        {% for schedule_entry in schedule_by_day.4 %}
                        <div class="mobile-subject-numbered">{{ forloop.counter }}. {{ schedule_entry.subject.name }}</div>
                        {% empty %}
                        <span class="mobile-no-subjects">No subjects</span>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="mobile-day-display">
                    <h4>Friday</h4>
                    <div class="mobile-subjects-display">
                        {% for schedule_entry in schedule_by_day.5 %}
                        <div class="mobile-subject-numbered">{{ forloop.counter }}. {{ schedule_entry.subject.name }}</div>
                        {% empty %}
                        <span class="mobile-no-subjects">No subjects</span>
                        {% endfor %}
                    </div>
                </div>
                
                {% if schedule_by_day.6 %}
                <div class="mobile-day-display">
                    <h4>Saturday</h4>
                    <div class="mobile-subjects-display">
                        {% for schedule_entry in schedule_by_day.6 %}
                        <div class="mobile-subject-numbered">{{ forloop.counter }}. {{ schedule_entry.subject.name }}</div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if schedule_by_day.7 %}
                <div class="mobile-day-display">
                    <h4>Sunday</h4>
                    <div class="mobile-subjects-display">
                        {% for schedule_entry in schedule_by_day.7 %}
                        <div class="mobile-subject-numbered">{{ forloop.counter }}. {{ schedule_entry.subject.name }}</div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            
        </div>
    </div>
    {% endif %}
    
    <!-- Mobile Schedule Management -->
    {% if has_active_schedule %}
    <div class="mobile-schedule-management">
        <h3>Schedule Management</h3>
        <div class="mobile-schedule-actions">
            <form method="POST" action="{% url 'schedule_manage' %}" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="action" value="create_new">
                <button type="submit" class="mobile-btn mobile-btn-primary">New Schedule</button>
            </form>
            <form method="POST" action="{% url 'schedule_manage' %}" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="action" value="disable_current">
                <button type="submit" class="mobile-btn mobile-btn-danger" onclick="return confirm('Delete current schedule?')">Delete</button>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Mobile-specific JavaScript functions
function toggleMobileScheduleForm() {
    const content = document.getElementById('mobile-schedule-content');
    const icon = document.getElementById('mobile-toggle-icon');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '▲';
    } else {
        content.style.display = 'none';
        icon.textContent = '▼';
    }
}

function toggleMobileSection(sectionId) {
    const content = document.getElementById('mobile-content-' + sectionId);
    const icon = document.getElementById('mobile-toggle-' + sectionId);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '▲';
        
        // Load existing tests when add-test section is opened
        if (sectionId === 'add-test') {
            loadMobileExistingTests();
        }
    } else {
        content.style.display = 'none';
        icon.textContent = '▼';
    }
}

function addMobileSubject(dayNumber) {
    const subjectsList = document.getElementById(`mobile_subjects_${dayNumber}`);
    const subjectItem = document.createElement('div');
    subjectItem.className = 'mobile-subject-item';
    
    const firstSelect = subjectsList.querySelector('select');
    let subjectsOptions = '';
    if (firstSelect) {
        subjectsOptions = firstSelect.innerHTML;
    } else {
        subjectsOptions = '<option value="">Select Subject</option>';
    }
    
    subjectItem.innerHTML = `
        <select name="subjects_${dayNumber}" class="mobile-subject-select">
            ${subjectsOptions}
        </select>
        <button type="button" class="mobile-remove-btn" onclick="removeMobileSubject(this)">×</button>
    `;
    
    subjectsList.appendChild(subjectItem);
    const newSelect = subjectItem.querySelector('select');
    newSelect.value = '';
}

function removeMobileSubject(button) {
    const subjectItem = button.parentElement;
    const subjectsList = subjectItem.parentElement;
    
    if (subjectsList.children.length > 1) {
        subjectItem.remove();
    } else {
        const select = subjectItem.querySelector('select');
        select.value = '';
    }
}

// Include all the existing JavaScript functions for subjects and books management
// (Same as the original home.html but adapted for mobile)

document.addEventListener('DOMContentLoaded', function() {
    console.log('Mobile page loaded, refreshing subjects and books...');
    
    const tbody = document.getElementById('subjects-books-tbody');
    if (tbody) {
        tbody.innerHTML = '';
    }
    
    loadSubjectsAndBooks();
});

function loadSubjectsAndBooks() {
    const timestamp = new Date().getTime();
    const random = Math.random();
    fetch(`/api/subjects-books/?t=${timestamp}&r=${random}&v=2`)
        .then(response => response.json())
        .then(data => {
            if (data.subjects) {
                renderSubjectsAndBooks(data.subjects);
            }
        })
        .catch(error => {
            console.error('Error loading subjects and books:', error);
        });
}

function renderSubjectsAndBooks(subjects) {
    const container = document.getElementById('subjects-books-container');
    container.innerHTML = '';
    
    subjects.forEach(subject => {
        const card = document.createElement('div');
        card.className = 'mobile-subject-book-card';
        card.innerHTML = `
            <div class="mobile-subject-header">
                <h4 class="mobile-subject-name" id="subject-name-${subject.id}" onclick="toggleSubjectRename(${subject.id})">${subject.name}</h4>
                <input type="text" class="mobile-subject-rename-input" id="subject-input-${subject.id}" value="${subject.name}" style="display: none;">
                <div class="mobile-subject-actions">
                    <button class="mobile-action-btn mobile-delete-btn" onclick="deleteSubject(${subject.id})">Delete</button>
                </div>
            </div>
            <div class="mobile-books-section">
                <div class="mobile-books-title">Books:</div>
                <div class="mobile-books-list" id="books-cell-${subject.id}">
                    ${renderBooks(subject.books)}
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

function renderBooks(books) {
    if (books.length === 0) {
        return '<div class="mobile-text-muted" style="padding: 1rem; text-align: center; color: #6c757d; font-style: italic;">No books added yet</div>';
    }
    
    return books.map(book => `
        <div class="mobile-book-item" id="book-item-${book.id}">
            <span class="mobile-book-title" id="book-title-${book.id}" onclick="toggleBookRename(${book.id})">${book.title}</span>
            <input type="text" class="mobile-book-rename-input" id="book-input-${book.id}" value="${book.title}" style="display: none;">
            <button class="mobile-book-delete-btn" onclick="deleteBook(${book.id})">×</button>
        </div>
    `).join('');
}

function toggleSubjectRename(subjectId) {
    const nameSpan = document.getElementById(`subject-name-${subjectId}`);
    const inputField = document.getElementById(`subject-input-${subjectId}`);
    
    if (nameSpan.style.display !== 'none') {
        nameSpan.style.display = 'none';
        inputField.style.display = 'inline-block';
        inputField.focus();
        inputField.select();
    } else {
        const newName = inputField.value.trim();
        if (newName && newName !== nameSpan.textContent) {
            renameSubject(subjectId, newName);
        } else {
            nameSpan.style.display = 'inline';
            inputField.style.display = 'none';
        }
    }
}

function toggleBookRename(bookId) {
    const titleSpan = document.getElementById(`book-title-${bookId}`);
    const inputField = document.getElementById(`book-input-${bookId}`);
    
    if (titleSpan.style.display !== 'none') {
        titleSpan.style.display = 'none';
        inputField.style.display = 'inline-block';
        inputField.focus();
        inputField.select();
    } else {
        const newTitle = inputField.value.trim();
        if (newTitle && newTitle !== titleSpan.textContent) {
            renameBook(bookId, newTitle);
        } else {
            titleSpan.style.display = 'inline';
            inputField.style.display = 'none';
        }
    }
}

function renameSubject(subjectId, newName) {
    fetch('/api/subjects-books/', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            action: 'rename_subject',
            id: subjectId,
            name: newName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const nameSpan = document.getElementById(`subject-name-${subjectId}`);
            const inputField = document.getElementById(`subject-input-${subjectId}`);
            
            nameSpan.textContent = data.name;
            nameSpan.style.display = 'inline';
            inputField.style.display = 'none';
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error renaming subject:', error);
        alert('Error renaming subject');
    });
}

function renameBook(bookId, newTitle) {
    fetch('/api/subjects-books/', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            action: 'rename_book',
            id: bookId,
            title: newTitle
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const titleSpan = document.getElementById(`book-title-${bookId}`);
            const inputField = document.getElementById(`book-input-${bookId}`);
            
            titleSpan.textContent = data.title;
            titleSpan.style.display = 'inline';
            inputField.style.display = 'none';
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error renaming book:', error);
        alert('Error renaming book');
    });
}

function deleteSubject(subjectId) {
    if (confirm('Delete this subject and all its books?')) {
        fetch('/api/subjects-books/', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                action: 'delete_subject',
                id: subjectId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadSubjectsAndBooks();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error deleting subject:', error);
            alert('Error deleting subject');
        });
    }
}

function deleteBook(bookId) {
    if (confirm('Delete this book?')) {
        fetch('/api/subjects-books/', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                action: 'delete_book',
                id: bookId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadSubjectsAndBooks();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error deleting book:', error);
            alert('Error deleting book');
        });
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Handle Enter key in rename inputs
document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        const input = e.target;
        if (input.classList.contains('mobile-subject-rename-input')) {
            const subjectId = input.id.replace('subject-input-', '');
            toggleSubjectRename(parseInt(subjectId));
        } else if (input.classList.contains('mobile-book-rename-input')) {
            const bookId = input.id.replace('book-input-', '');
            toggleBookRename(parseInt(bookId));
        }
    }
});

// Handle Escape key to cancel rename
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const input = e.target;
        if (input.classList.contains('mobile-subject-rename-input')) {
            const subjectId = input.id.replace('subject-input-', '');
            const nameSpan = document.getElementById(`subject-name-${subjectId}`);
            const inputField = document.getElementById(`subject-input-${subjectId}`);
            
            nameSpan.style.display = 'inline';
            inputField.style.display = 'none';
        } else if (input.classList.contains('mobile-book-rename-input')) {
            const bookId = input.id.replace('book-input-', '');
            const titleSpan = document.getElementById(`book-title-${bookId}`);
            const inputField = document.getElementById(`book-input-${bookId}`);
            
            titleSpan.style.display = 'inline';
            inputField.style.display = 'none';
        }
    }
});

// Mobile Test Functionality
function openMobileDatePicker() {
    const dateInput = document.getElementById('mobile_test_date');
    if (dateInput) {
        // Set first day of week to Monday (1 = Monday, 0 = Sunday)
        try {
            // Try different methods to set first day of week
            if (dateInput.setAttribute) {
                dateInput.setAttribute('data-firstdayofweek', '1');
            }
            if (dateInput.firstDayOfWeek !== undefined) {
                dateInput.firstDayOfWeek = 1;
            }
            // Some browsers support this property
            if (dateInput.setAttribute) {
                dateInput.setAttribute('data-weekstart', '1');
            }
        } catch (e) {
            console.log('First day of week setting not supported:', e);
        }
        
        // Force focus and trigger the date picker
        dateInput.focus();
        if (dateInput.showPicker) {
            dateInput.showPicker();
        } else {
            dateInput.click();
        }
    }
}

// Load existing tests when the section is opened
function loadMobileExistingTests() {
    console.log('Loading mobile existing tests...');
    fetch('{% url "home" %}', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('Tests response received:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Tests data received:', data);
        if (data.tests) {
            const chipsContainer = document.getElementById('mobile-test-chips');
            console.log('Chips container found:', chipsContainer);
            chipsContainer.innerHTML = '';
            
            console.log('Number of tests to display:', data.tests.length);
            data.tests.forEach((test, index) => {
                console.log(`Creating chip ${index + 1}:`, test);
                const chip = document.createElement('div');
                chip.className = 'mobile-test-chip';
                chip.dataset.date = test.date;
                chip.dataset.subjectId = test.subject_id;
                chip.innerHTML = `
                    <span class="mobile-chip-text">${test.subject_name} (<strong>${formatDateToDDMMYYYY(new Date(test.date))}</strong>)</span>
                    <button type="button" class="mobile-chip-remove" onclick="removeMobileTestChip(this)">×</button>
                `;
                chipsContainer.appendChild(chip);
            });
            console.log('All test chips added to container');
        } else {
            console.log('No tests data received');
        }
    })
    .catch(error => {
        console.error('Error loading existing tests:', error);
    });
}

function removeMobileTestChip(button) {
    const chip = button.closest('.mobile-test-chip');
    const date = chip.dataset.date;
    const subjectId = chip.dataset.subjectId;
    
    // Convert date back to server format for deletion
    const dateObj = parseDDMMYYYYToDate(formatDateToDDMMYYYY(new Date(date)));
    if (dateObj) {
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        const serverDate = `${year}-${month}-${day}`;
        
        deleteMobileTestFromServer(serverDate, subjectId, chip);
    }
}

function deleteMobileTestFromServer(date, subjectId, chip) {
    fetch('{% url "home" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `action=delete_test&test_date=${encodeURIComponent(date)}&test_subject=${encodeURIComponent(subjectId)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            chip.remove();
        } else {
            console.error('Delete failed:', data.error);
        }
    })
    .catch(error => {
        console.error('Error deleting test:', error);
    });
}

function formatDateToDDMMYYYY(date) {
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}.${month}.${year}`;
}

function parseDDMMYYYYToDate(dateStr) {
    const parts = dateStr.split('.');
    if (parts.length === 3) {
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const year = parseInt(parts[2], 10);
        return new Date(year, month, day);
    }
    return null;
}

// Update mobile date display when date changes
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('mobile_test_date');
    const dateDisplay = document.getElementById('mobile-date-display');
    
    if (dateInput && dateDisplay) {
        // Set first day of week to Monday (1 = Monday, 0 = Sunday)
        try {
            // Try multiple methods to set first day of week
            dateInput.setAttribute('data-firstdayofweek', '1');
            dateInput.setAttribute('data-weekstart', '1');
            dateInput.setAttribute('data-firstday', '1');
            
            // Some browsers support these properties
            if (dateInput.firstDayOfWeek !== undefined) {
                dateInput.firstDayOfWeek = 1;
            }
            if (dateInput.weekStart !== undefined) {
                dateInput.weekStart = 1;
            }
            if (dateInput.firstDay !== undefined) {
                dateInput.firstDay = 1;
            }
            
            console.log('Set first day of week to Monday');
        } catch (e) {
            console.log('First day of week setting not supported:', e);
        }
        
        // Add click event listener to the date input as backup
        dateInput.addEventListener('click', function(e) {
            e.stopPropagation();
            this.focus();
            if (this.showPicker) {
                this.showPicker();
            }
        });
        
        dateInput.addEventListener('change', function() {
            if (this.value) {
                const date = new Date(this.value);
                dateDisplay.textContent = formatDateToDDMMYYYY(date);
                dateDisplay.classList.add('has-date');
            } else {
                dateDisplay.textContent = 'Select Date';
                dateDisplay.classList.remove('has-date');
            }
        });
    }
    
    // Handle mobile test form submission
    const mobileTestForm = document.getElementById('mobile-test-form');
    if (mobileTestForm) {
        console.log('Mobile test form found, adding event listener');
        mobileTestForm.addEventListener('submit', function(e) {
            console.log('Form submitted, preventing default');
            e.preventDefault();
            
            const formData = new FormData(this);
            const dateInput = document.getElementById('mobile_test_date');
            const subjectSelect = document.getElementById('mobile_test_subject');
            const dateDisplay = document.getElementById('mobile-date-display');
            
            console.log('Form data:', {
                date: formData.get('test_date'),
                subject: formData.get('test_subject'),
                action: formData.get('action')
            });
            
            fetch('{% url "home" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            })
            .then(response => {
                console.log('Response received:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    console.log('Test saved successfully, clearing form and reloading tests');
                    // Clear the form fields
                    dateInput.value = '';
                    subjectSelect.value = '';
                    dateDisplay.textContent = 'Select Date';
                    dateDisplay.classList.remove('has-date');
                    
                    // Reload existing tests to show the new one
                    loadMobileExistingTests();
                } else {
                    console.error('Save failed:', data.error || data.message);
                }
            })
            .catch(error => {
                console.error('Error saving test:', error);
            });
        });
    } else {
        console.error('Mobile test form not found!');
    }
});

</script>
{% endblock %}
